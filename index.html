<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Block Drop Game</title>
  
  <!-- ‚úÖ Ethers.js Library -->
  <script src="https://cdn.ethers.io/lib/ethers-5.2.umd.min.js"></script>
  
  <!-- ‚úÖ Web3 Integration -->
  <script src="web3-integration.js"></script>

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: Arial, sans-serif;
      background: linear-gradient(135deg, #1a1a2e, #0f3460);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    #game {
      background: rgba(0,0,0,0.4);
      padding: 30px;
      border-radius: 20px;
      color: white;
      max-width: 800px;
    }
    h1 { text-align: center; margin-bottom: 20px; }
    button {
      padding: 12px 24px;
      margin: 5px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
      font-size: 14px;
    }
    .connect-btn { background: #3b82f6; color: white; width: 100%; margin-bottom: 20px; }
    .connect-btn.connected { background: #10b981; }
    #board {
      display: inline-grid;
      grid-template-columns: repeat(10, 25px);
      gap: 1px;
      background: #0a0a0a;
      padding: 1px;
      margin: 20px auto;
    }
    .cell { width: 25px; height: 25px; background: #1a1a2e; }
    .controls { display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; margin-top: 20px; }
    .controls button { background: #3b82f6; color: white; padding: 15px 30px; font-size: 18px; }
    .info { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 20px; }
    .info-box { background: linear-gradient(135deg, #667eea, #764ba2); padding: 15px; border-radius: 12px; text-align: center; }
    .info-box .label { font-size: 12px; opacity: 0.9; }
    .info-box .value { font-size: 28px; font-weight: bold; margin-top: 5px; }
    .game-controls { display: flex; gap: 10px; margin-bottom: 20px; }
    .game-controls button { flex: 1; }
    .submit-btn { background: #8b5cf6; color: white; }
    .leaderboard-btn { background: #f59e0b; color: white; }
    .pause-btn { background: #eab308; color: black; }
    .new-btn { background: #10b981; color: white; }
  </style>
</head>

<body>
  <div id="game">
    <h1>üéÆ Block Drop</h1>
    <p style="text-align: center; opacity: 0.7; margin-bottom: 20px; font-size: 12px;">Contract: 0xa6A7...aBaf</p>

    <button id="connectBtn" class="connect-btn" onclick="connectWalletHandler()">üîó Connect Wallet</button>

    <div class="info">
      <div class="info-box">
        <div class="label">Score</div>
        <div class="value" id="score">0</div>
      </div>
      <div class="info-box">
        <div class="label">Lines</div>
        <div class="value" id="lines">0</div>
      </div>
      <div class="info-box">
        <div class="label">Level</div>
        <div class="value" id="level">1</div>
      </div>
    </div>

    <div class="game-controls">
      <button class="pause-btn" onclick="togglePause()">‚è∏Ô∏è Pause</button>
      <button class="new-btn" onclick="startNewGame()">üîÑ New Game</button>
    </div>

    <div class="game-controls" id="web3controls" style="display: none;">
      <button class="submit-btn" onclick="submitScoreHandler()">üì§ Submit Score</button>
      <button class="leaderboard-btn" onclick="showLeaderboardHandler()">üèÜ Leaderboard</button>
    </div>

    <div style="text-align: center;">
      <div id="board"></div>
    </div>

    <div class="controls">
      <button onclick="move(-1)">‚Üê</button>
      <button onclick="rotate()">‚Üª</button>
      <button onclick="hardDrop()">‚Üì‚Üì</button>
      <button onclick="move(1)">‚Üí</button>
    </div>

    <p style="text-align: center; margin-top: 20px; opacity: 0.7; font-size: 13px;">
      Arrow Keys: Move & Rotate | Space: Hard Drop | P: Pause
    </p>
  </div>

  <script>
    /*************** GAME LOGIC (same as your original) ***************/
    const BOARD_WIDTH = 10, BOARD_HEIGHT = 20;
    const SHAPES = [[[1,1,1,1]], [[1,1],[1,1]], [[1,1,1],[0,1,0]], [[1,1,1],[1,0,0]], [[1,1,1],[0,0,1]], [[1,1,0],[0,1,1]], [[0,1,1],[1,1,0]]];
    const COLORS = ['#FF6B6B', '#4ECDC4', '#45B7D1', '#FFA07A', '#98D8C8', '#F7DC6F', '#BB8FCE'];
    let board, currentPiece, position, score = 0, lines = 0, level = 1, gameOver = false, isPaused = false, gameInterval = null;

    function initBoard() {
      const boardEl = document.getElementById('board');
      boardEl.innerHTML = '';
      for (let y = 0; y < BOARD_HEIGHT; y++) {
        for (let x = 0; x < BOARD_WIDTH; x++) {
          const cell = document.createElement('div');
          cell.className = 'cell';
          cell.id = `cell-${y}-${x}`;
          boardEl.appendChild(cell);
        }
      }
    }

    function render() {
      for (let y = 0; y < BOARD_HEIGHT; y++) {
        for (let x = 0; x < BOARD_WIDTH; x++) {
          const cell = document.getElementById(`cell-${y}-${x}`);
          cell.style.backgroundColor = board[y][x] || '#1a1a2e';
        }
      }
      if (currentPiece) {
        currentPiece.shape.forEach((row, y) => {
          row.forEach((val, x) => {
            if (val) {
              const bx = position.x + x, by = position.y + y;
              if (by >= 0 && by < BOARD_HEIGHT && bx >= 0 && bx < BOARD_WIDTH)
                document.getElementById(`cell-${by}-${bx}`).style.backgroundColor = currentPiece.color;
            }
          });
        });
      }
      document.getElementById('score').textContent = score.toLocaleString();
      document.getElementById('lines').textContent = lines;
      document.getElementById('level').textContent = level;
    }

    function createPiece() { const i = Math.floor(Math.random() * SHAPES.length); return { shape: SHAPES[i], color: COLORS[i] }; }

    function checkCollision(p, pos) {
      for (let y = 0; y < p.shape.length; y++)
        for (let x = 0; x < p.shape[y].length; x++)
          if (p.shape[y][x]) {
            const nx = pos.x + x, ny = pos.y + y;
            if (nx < 0 || nx >= BOARD_WIDTH || ny >= BOARD_HEIGHT || (ny >= 0 && board[ny][nx])) return true;
          }
      return false;
    }

    function mergePiece() {
      currentPiece.shape.forEach((row, y) => row.forEach((v, x) => { if (v && position.y + y >= 0) board[position.y + y][position.x + x] = currentPiece.color; }));
    }

    function clearLines() {
      let cleared = 0;
      for (let y = BOARD_HEIGHT - 1; y >= 0; y--) {
        if (board[y].every(c => c !== 0)) {
          board.splice(y, 1);
          board.unshift(Array(BOARD_WIDTH).fill(0));
          cleared++; y++;
        }
      }
      if (cleared) { lines += cleared; score += cleared * 100 * level; level = Math.floor(lines / 10) + 1; }
    }

    function moveDown() {
      if (isPaused || gameOver) return;
      const np = {x: position.x, y: position.y + 1};
      if (!checkCollision(currentPiece, np)) position = np;
      else {
        mergePiece(); clearLines();
        currentPiece = createPiece(); position = {x: 4, y: 0};
        if (checkCollision(currentPiece, position)) { gameOver = true; clearInterval(gameInterval); alert(`Game Over! Final Score: ${score}`); }
      }
      render();
    }

    function move(d) { if (!isPaused && !gameOver && !checkCollision(currentPiece, {x: position.x + d, y: position.y})) { position.x += d; render(); } }
    function rotate() {
      if (isPaused || gameOver) return;
      const r = currentPiece.shape[0].map((_, i) => currentPiece.shape.map(r => r[i]).reverse());
      const rp = {...currentPiece, shape: r};
      if (!checkCollision(rp, position)) currentPiece = rp;
      render();
    }
    function hardDrop() { while (!checkCollision(currentPiece, {x: position.x, y: position.y + 1})) position.y++; render(); setTimeout(moveDown, 50); }
    function togglePause() { isPaused = !isPaused; document.querySelector('.pause-btn').textContent = isPaused ? '‚ñ∂Ô∏è Resume' : '‚è∏Ô∏è Pause'; }
    function startNewGame() { board = Array(BOARD_HEIGHT).fill().map(() => Array(BOARD_WIDTH).fill(0)); currentPiece = createPiece(); position = {x:4,y:0}; score=0;lines=0;level=1;gameOver=false;isPaused=false; if(gameInterval) clearInterval(gameInterval); gameInterval=setInterval(moveDown,1000); render(); }

    document.addEventListener('keydown', e => {
      if (gameOver) return;
      if (e.key === 'ArrowLeft') move(-1);
      else if (e.key === 'ArrowRight') move(1);
      else if (e.key === 'ArrowDown') moveDown();
      else if (e.key === 'ArrowUp') rotate();
      else if (e.key === ' ') { e.preventDefault(); hardDrop(); }
      else if (e.key.toLowerCase() === 'p') togglePause();
    });

    window.onload = () => { initBoard(); startNewGame(); };

    /*************** WEB3 HANDLERS ***************/
    async function connectWalletHandler() {
      try {
        const { address } = await connectWallet();
        document.getElementById('connectBtn').textContent = `üîó ${address.slice(0,6)}...${address.slice(-4)}`;
        document.getElementById('connectBtn').classList.add('connected');
        document.getElementById('web3controls').style.display = 'flex';
        alert('‚úÖ Wallet Connected!');
      } catch (err) {
        alert('‚ùå ' + err.message);
      }
    }

    async function submitScoreHandler() {
      if (score <= 0) return alert('Play before submitting!');
      const username = prompt('Enter your username (max 20 chars):');
      if (!username) return;
      const result = await submitScoreToBlockchain(score, level, lines, username);
      alert(result.success ? `üéâ Score submitted!\nTx: ${result.transactionHash}` : '‚ùå ' + result.error);
    }

    async function showLeaderboardHandler() {
      const leaderboard = await getLeaderboard();
      let msg = 'üèÜ TOP 10 LEADERBOARD üèÜ\n\n';
      leaderboard.forEach((s, i) => {
        msg += `${i+1}. ${s.username || s.player.slice(0,8)}\n   Score: ${s.score.toLocaleString()} | Level: ${s.level}\n\n`;
      });
      alert(msg);
    }
  </script>
</body>
</html>
